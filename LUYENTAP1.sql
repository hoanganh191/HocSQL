CREATE DATABASE TULUYEN1
USE TULUYEN1

CREATE TABLE KHACHHANG(
	MAKH VARCHAR(4) PRIMARY KEY,
	HOTEN NVARCHAR(50),
	DIACHI NVARCHAR(50),
	DIENTHOAI VARCHAR(10) NOT NULL CHECK(LEN(DIENTHOAI) = 10 AND DIENTHOAI NOT LIKE '%[^0-9]%')
)

CREATE TABLE SANPHAM(
	MASP VARCHAR(4) PRIMARY KEY,
	TENSP NVARCHAR(50),
	GIA INT CHECK (GIA > 0),
	SOLUONG INT CHECK (SOLUONG > 0)
)

CREATE TABLE HOADON(
	MAHD VARCHAR(4) PRIMARY KEY,
	NGAYLAP DATE CHECK (NGAYLAP <= GETDATE()),
	MAKH VARCHAR(4),
	CONSTRAINT FK_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)
)

CREATE TABLE CTHOADON (
	MAHD VARCHAR(4),
	MASP VARCHAR(4),
	SOLUONG INT CHECK (SOLUONG > 0)
	CONSTRAINT PK_CRHOADON PRIMARY KEY (MAHD,MASP),
	CONSTRAINT FK_MAHD FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD),
	CONSTRAINT FK_MASP FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)
)

INSERT INTO KHACHHANG VALUES 
('KH01',N'Nguyễn Văn A',N'Hà Nội','0912345678'),
('KH02',N'Trần Thị B',N'TP.HCM','0987654321'),
('KH03',N'Lê Văn C',N'Hàỉ Phòng','0933334444')

INSERT INTO SANPHAM VALUES 
('SP01',N'Laptop',15000,10),
('SP02',N'Chuột',200,50),
('SP03',N'Bàn Phím',500,30)

SET DATEFORMAT DMY
INSERT INTO HOADON VALUES
('HD01','10-1-2024','KH01'),
('HD02','12-2-2024','KH02'),
('HD03','15-3-2024','KH01')

INSERT INTO CTHOADON VALUES
('HD01','SP01',1),
('HD01','SP02',2),
('HD02','SP03',1),
('HD03','SP02',5)

--Viết câu lệnh thêm cột GHICHU vào bảng SANPHAM.
ALTER TABLE SANPHAM ADD GHICHU NVARCHAR(50)

--Tạo truy vấn đưa ra danh sách sản phẩm chưa từng được bán.
SELECT * 
FROM SANPHAM
WHERE MASP NOT IN (SELECT MASP FROM CTHOADON)

--Tạo truy vấn đưa ra khách hàng có tổng số tiền mua hàng nhiều nhất.
SELECT  HD.MAKH,HOTEN,SUM(CT.SOLUONG*GIA) AS TONGTIEN
FROM CTHOADON CT
JOIN HOADON HD ON CT.MAHD = HD.MAHD 
JOIN SANPHAM SP ON CT.MASP = SP.MASP
JOIN KHACHHANG KH ON KH.MAKH = HD.MAKH
GROUP BY HD.MAKH,HOTEN
ORDER BY TONGTIEN DESC

--Tạo view đưa ra danh sách hóa đơn gồm MAHD, HOTEN khách hàng, tổng tiền.
CREATE VIEW DSHOADON
AS
SELECT  CT.MAHD,HOTEN,SUM(GIA*CT.SOLUONG) AS TONGTIEN
FROM HOADON HD 
JOIN KHACHHANG KH ON KH.MAKH = HD.MAKH
JOIN CTHOADON CT ON CT.MAHD = HD.MAHD
JOIN SANPHAM SP ON CT.MASP = SP.MASP
GROUP BY CT.MAHD,HOTEN

SELECT * FROM DSHOADON

